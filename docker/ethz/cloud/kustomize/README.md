Kustomization Base for Kubernetes
=================================

This kustomization directory provides a base which has to be extended by just a few
mandatory items:

 - environment variables like database connection information
 - an ingress definition for the GUI

 See the example directory for a usage introduction.

Variables sebserver webservice
------------------------------
 - `JAVA_HEAP_MIN`: Minimum heap memory space given to the JVM process
 - `JAVA_HEAP_MAX`: Maximum heap memory space given to the JVM process
 - `sebserver_password`: SEB Server internal password for encryption. NOTE: This password must be the same vor all webservice and gui instances
 - `spring_profiles_active`: SEB Server profiles. For a productive webservice setup "ws,prod-ws,prod"
 - `spring_datasource_password`: password for MariaDB database
 - `spring_datasource_username`: MariaDB user name
 - `datastore_mariadb_server_address`: MariaDB server hostname
 - `datastore_mariadb_server_port`: MariaDB port
 - `sebserver_webservice_http_external_scheme`: Webservice external URL scheme (http/https)
 - `sebserver_webservice_http_external_servername`: Webservice external URL host name
 - `sebserver_webservice_http_external_port`: Webservice external URL port (empty for default http(80) https(443))
 - `sebserver_webservice_autologin_url`: External URL from where the sebserver guiservice is available. See also `sebserver_gui_http_external_servername`
 - `sebserver_feature_exam_seb_screenProctoring_bundled_url`: The URL on which the screen proctoring webservice is externally available
 - `sps_sebserver_client_secret`: SEB Servers client secret to connect to screen proctoring service. This must match with the sebserver_client_secret setting in screen proctoring (sps) webservice
 - `sps_sebserver_password`: SEB Servers screen proctoring service maintenance account password. This must match with the same setting in screen proctoring (sps) webservice
 
Variables sebserver guiservice
------------------------------

 - `JAVA_HEAP_MIN`: Minimum heap memory space given to the JVM process
 - `JAVA_HEAP_MAX`: Maximum heap memory space given to the JVM process
 - `sebserver_password` : SEB Server internal password for encryption. NOTE: This password must be the same vor all webservice and gui instances
 - `spring_profiles_active` : SEB Server profiles. For a productive guiservice setup "gui,prod-gui,prod"
 - `sebserver_gui_http_external_scheme`: Guiservice external URL scheme (http/https)
 - `sebserver_gui_http_external_servername`: Guiservice external URL host name
 - `sebserver_gui_http_external_port`: Guiservice external URL port (empty for default http(80) https(443))
 - `sebserver_gui_http_webservice_scheme`: Webservice external connection URL scheme (http/https)
 - `sebserver_gui_http_webservice_servername` : Webservice external connection URL host name.
 - `sebserver_gui_http_webservice_port` : Webservice external connection URL port (empty for default http(80) https(443))

Variables screen proctoring (sps) webservice
--------------------------------------------

- `JAVA_HEAP_MIN`: Minimum heap memory space given to the JVM process
- `JAVA_HEAP_MAX`: Maximum heap memory space given to the JVM process
- `sebserver_password`: SEB Server internal password for encryption. NOTE: This password must be the same vor all webservice and gui instances
- `spring_profiles_active`: SEB Server profiles. For a productive webservice setup "prod"
- `spring_datasource_password`: password for MariaDB database
- `spring_datasource_username`: MariaDB user name
- `datastore_mariadb_server_address`: MariaDB server hostname
- `datastore_mariadb_server_port`: MariaDB port
- `sps_data_store_adapter`: Image (Screenshots) data store adapter. "FULL_RDBMS" for storing images into DB or "S3_RDBMS" for S3 compatible storage
- `sps_webservice_http_external_scheme`: Webservice external URL scheme (http/https)
- `sps_webservice_http_external_servername`: Webservice external URL host name
- `sps_webservice_http_external_port`: Webservice external URL port (empty for default http(80) https(443))
- `sps_gui_redirect_url`: SPS GUI external URL used for redirect and autologin link creation
- `sebserver_client_secret`: Client secret for SEB Server binding. SEB Server must use this to connect to screen proctoring service. See also sps_sebserver_client_secret
- `spsgui_client_secret`: Client secret for screen proctoring GUI service binding. SPS GUI service must use this to connect to the SPS webservice
- `sps_init_sebserveraccount_password`: Password for the SEB Server user account that is used by SEB Server to manage SPS service data. This account is initially generated by the SPS service if it doesn't exist

Variables sebserver screen proctoring (sps) guiservice
------------------------------------------------------

- `NODE_ENV`: Node environment profile. "prod" for production setup
- `SERVER_PORT`: Internal service port mapping. Default is "3000"
- `VITE_SERVER_URL`: The external URL of the VITE server
- `VITE_SERVER_PORT`: The port mapping for above VITE server URL if needed. If not needed (default ports http/https) this can be empty
- `PROCTOR_SERVER_URL`: The external URL of the screen proctoring webservice. This can also be internal URL connection to sps-webservice
- `PROCTOR_SERVER_PORT`: Port mapping for above screen proctoring webservice URL if needed. If not needed (default ports http/https) this can be empty
- `PROCTOR_DEFAULT_URL`: Default webservice root API endpoint. Usually "/admin-api/v1"
- `PROCTOR_SERVER_USERNAME`: Client id name for sps-guiservice to connect to sps-webservice. Default is "spsGuiClient"
- `PROCTOR_SERVER_PASSWORD`: Client secret for sps-guiservice to connect to sps-webservice. Must match with spsgui_client_secret
- `SEB_SERVER_INTEGRATED_MODE`: Integration mode. Default is true


Replacing values with secret references
---------------------------------------

To replace a variable value

```yaml
- name: sebserver_password
  value: password_123456
```
with a key reference

```yaml
- name: sebserver_password
  valueFrom:
    secretKeyRef:
      name: sebservercredentials
      key: SEBSERVER_PWD
```
you first have to delete the variable, then add it again. Otherwise you will end up with
```yaml
- name: sebserver_password
  value: password_123456
  valueFrom:
    secretKeyRef:
      name: sebservercredentials
      key: SEBSERVER_PWD
```
which is valid YAML, but refused by Kubernetes.

Delete with a patch:
```yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seb-webservice
spec:
  template:
    spec:
      containers:
        - name: seb-webservice
          env:
            - name: sebserver_password
              $patch: delete
```
then patch it back:
```yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seb-webservice
spec:
  template:
    spec:
      containers:
        - name: seb-webservice
          env:
            - name: sebserver_password
              valueFrom:
                secretKeyRef:
                  name: sebservercredentials
                  key: SEBSERVER_PWD
```


Versions
--------

The version of *kustomize* included in `kubectl` usually lags behind the standalone tool.
To get the full set of features mentioned in the documentation, get the standalone binary.

Links
-----

kustomize website: https://kustomize.io/
kustomize introduction: https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/
kustomize guides and reference: https://kubectl.docs.kubernetes.io/guides/
